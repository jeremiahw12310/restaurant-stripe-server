rules_version = '2';

// Craft rules based on data in your Firestore database
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn()
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isVideo() {
      return request.resource.contentType.matches('video/.*');
    }

    // Allow public read access to image files at root level (menu item images, icons, etc.)
    // Only image extensions are allowed - no sensitive files can be exposed
    match /{fileName} {
      allow read: if fileName.matches('.*\\.(png|jpg|jpeg|gif|webp)$');
    }
    
    // Allow authenticated users to upload community posts (images and videos)
    match /community_posts/{fileName} {
      allow read: if true; // Public read access to community posts
      // Only allow uploads (create). Prevent edits/deletes since we don't have an owner-scoped path here.
      allow create: if isSignedIn()
        && request.resource.size < 25 * 1024 * 1024
        && (isImage() || isVideo());
      allow update, delete: if isAdmin();
    }
    
    // Allow only the owner to manage their own profile photo (must be named <UID>.jpg)
    match /profile_photos/{userIdFile} {
      allow read: if isSignedIn() && userIdFile.matches('^' + request.auth.uid + '\\.jpg$');
      allow create, update: if isSignedIn()
        && userIdFile.matches('^' + request.auth.uid + '\\.jpg$')
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType == 'image/jpeg';
      allow delete: if isSignedIn()
        && userIdFile.matches('^' + request.auth.uid + '\\.jpg$');
    }
    
    // Allow admin users to manage promo slides (images for the carousel)
    match /promo_slides/{fileName} {
      allow read: if true; // Public read access to promo slides
      allow create, update: if isAdmin()
        && request.resource.size < 10 * 1024 * 1024
        && isImage();
      allow delete: if isAdmin();
    }
    
    // Allow admin users to manage category icons (PNG files shown for categories)
    match /category_icons/{fileName} {
      allow read: if true; // Public read access to category icons
      allow create, update: if isAdmin()
        && request.resource.size < 5 * 1024 * 1024
        && isImage();
      allow delete: if isAdmin();
    }
    
    // Allow admin users to manage menu item images
    match /menu_images/{fileName} {
      allow read: if true; // Public read access to item images
      allow create, update: if isAdmin()
        && request.resource.size < 10 * 1024 * 1024
        && isImage();
      allow delete: if isAdmin();
    }
    
    // Default rule - deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 